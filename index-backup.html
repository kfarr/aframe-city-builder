<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame City Builder</title>
    <meta name="description" content="A-Frame City Builder">

    <!-- using aframe master until next stable -->
    <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.js"></script>

    <!-- jquery for city builder app components -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <!-- this was a build script but webpack was too annoying so not used for now -->
    <!-- <script src="lib/dist/aframe-city-builder.js"></script> -->

    <!-- for desktop menu overlay -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />

    <!-- components used -->
    <!-- <script src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
    <script src="https://rawgit.com/ngokevin/kframe/master/components/text/dist/aframe-text-component.min.js"></script> -->
    <script src="https://rawgit.com/ngokevin/aframe-animation-component/master/dist/aframe-animation-component.js"></script>
    <script src="https://rawgit.com/kfarr/aframe-gridhelper/master/dist/aframe-gridhelper-component.min.js"></script>
    <script src="lib/skyGradient.js"></script>
    <script src="lib/ground.js"></script>
    <script src="lib/aframe-select-bar.js"></script>
    <script src="lib/builder-controls.js"></script>

    <!-- <script src="https://unpkg.com/aframe-firebase-component@^4.0.0/dist/aframe-firebase-component.min.js"></script> -->
    <!-- <script src="https://rawgit.com/kfarr/aframe-city-firebase/master/dist/aframe-city-firebase-component.js"></script> -->

    <style>
          .intro-overlay {
            z-index: 1;
            position: absolute;
            top: 20px;
            left: 20px;
            max-width: 700px;
            box-sizing: border-box;
            padding: 1.5em;
            color: #FFF;
            background: rgba(0, 0, 0, 0.75);
            font-family: Source Sans Pro, Helvetica Neue, Helvetica, Arial, sans-serif;
          }
          .menu-overlay {
            z-index: 99999;
            position: fixed;
            top: 20px;
            right: 20px;
            box-sizing: border-box;
            padding: 1.5em;
            width: 60px;
            height: 60px;
            padding-bottom: 0px;
            background: rgba(0, 0, 0, 0.5) url(./assets/images/hamburger-white.png) center no-repeat;
            background-size: 40px 40px;
            font-family: Source Sans Pro, Helvetica Neue, Helvetica, Arial, sans-serif;
          }
          .menu-overlay:hover {
            background: rgba(0, 0, 0, 0.2) url(./assets/images/hamburger-white.png) center no-repeat;
            background-size: 40px 40px;
          }
        </style>
  </head>
  <body>
    <a-scene id="my-scene" antialias="true" >
      <a-assets>

        <!-- scene items -->
        <a-asset-item id="table-obj" src="assets/environment/table.obj"></a-asset-item>
        <a-asset-item id="table-mtl" src="assets/environment/table.mtl"></a-asset-item>
        <a-asset-item id="env_arrow" src="assets/environment/env_arrow.obj"></a-asset-item>

        <!-- geometric city builder text -->
        <img id="chrome" src="assets/environment/env_map_chrome.jpg">
        <a-asset-item id="exoBlackRegular" src="assets/environment/env_exo_black_regular.js"></a-asset-item>
        <a-asset-item id="exoBoldItalic" src="assets/environment/env_exo_bold_italic.js"></a-asset-item>

        <a-mixin id="avatar"
                        geometry="primitive: box; depth: 0.3; height: 0.3; width: 0.3"
                        material="color: #222"></a-mixin>
        <a-mixin id="eye" geometry="primitive: circle; radius: 0.08"
                        material="shader: flat; side: double"></a-mixin>
        <a-mixin id="eyePupil" geometry="primitive: circle; radius: 0.02"
                        material="shader: flat; side: double; color: #222"></a-mixin>

      </a-assets>

      <!-- Player -->
      <a-entity id="cameraWrapper" position="0.05 0.41 0.34" rotation="-43.5 0.80 0" firebase-broadcast >
      <!-- <a-entity id="cameraWrapper" position="-1.06 1.31 1.82" rotation="-12.834254610930437 -16.844959176846217 0"> -->
        <a-entity id="camera" camera look-controls wasd-controls="fly: true"  firebase-broadcast="components: position, rotation" >

          <!-- Avatar - should be invisible for local player -->
          <a-entity mixin="avatar" visible="false" firebase-broadcast="components: mixin">
            <a-entity rotation="0 180 0" firebase-broadcast="components: rotation">
              <a-entity mixin="eye" position="-0.1 0.1 0.18" firebase-broadcast="components: mixin, position">
                <a-entity mixin="eyePupil" position="0 0 0.03" firebase-broadcast="components: mixin, position"></a-entity>
              </a-entity>
              <a-entity mixin="eye" position="0.1 0.1 0.18" firebase-broadcast="components: mixin, position">
                <a-entity mixin="eyePupil" position="0 0 0.03" firebase-broadcast="components: mixin, position"></a-entity>
              </a-entity>
            </a-entity>
          </a-entity>

        </a-entity>
      </a-entity>

      <a-entity id="DEVmenuWrapper" position="0 0.2 -0.4" rotation="85 0 0"></a-entity>

      <!-- Left Hand -->
      <!-- <a-entity id="leftController" wasd-controls > -->
      <!-- <a-entity builder-controls id="leftController" wasd-controls oculus-touch-controls="hand: left" vive-controls="hand: left" > -->
      <a-entity id="leftController" wasd-controls oculus-touch-controls="hand: left" vive-controls="hand: left" >
      <!-- <a-entity id="leftItem" file="base_street" objectGroup="kfarr_bases" objectId="1" obj-model="obj: url(assets/obj/base_street1.obj); mtl: url(assets/obj/base_street1.mtl)" scale="0.01 0.01 0.01" position="0 0 -0.25" rotation="0 90 0"></a-entity> -->
        <a-entity select-bar="controllerID: leftController" id="menuActions" scale="0.7 0.7 0.7" position="0 0.05 0.08" rotation="-85 0 0">

          <optgroup label="Actions" value="actions">
            <option value="teleport" src="assets/environment/icon_teleport.png" selected>Teleport</option>
            <option value="save" src="assets/environment/icon_save.png">Save</option>
            <option value="saveAs" src="assets/environment/icon_saveAs.png">Save As Copy</option>
            <option value="new" src="assets/environment/icon_new.png">New</option>
            <option value="erase" src="assets/environment/icon_erase.png">Erase</option>
            <option value="inspect" src="assets/environment/icon_inspect.png">Inspect</option>
            <option value="inspect2" src="assets/environment/icon_inspect.png">Inspect2</option>
          </optgroup>

        </a-entity>


      </a-entity>

      <!-- Right Hand -->
      <a-entity builder-controls="menuId: menuObjects" id="rightController" oculus-touch-controls="hand: right" vive-controls="hand: right" firebase-broadcast="components: position, scale, rotation">
        <a-entity id="rightItem" firebase-broadcast="components: position, obj-model, scale, rotation" file="base_street1" objectGroup="kfarr_bases" objectId="0" obj-model="obj: url(assets/obj/base_street1.obj); mtl: url(assets/obj/base_street1.mtl)" rotation="-56.8 0 0" scale="0.01 0.01 0.01" position="0 -0.08 -0.09"></a-entity>
        <a-entity id="rightArm" mixins="arm" firebase-broadcast="components: mixins" ></a-entity>
        <a-entity select-bar id="menuObjects" scale="0.7 0.7 0.7" position="0 0.05 0.08" rotation="-85 0 0">

          <optgroup label="Bases" value="kfarr_bases">
            <option value="base_street1" src="assets/preview/base_street1.jpg" selected>Street</option>
            <option value="base_grass1" src="assets/preview/base_grass1.jpg">Grass</option>
            <option value="base_crossstreet" src="assets/preview/base_crossstreet.jpg">Cross Street</option>
            <option value="scene_house6" src="assets/preview/scene_house6.jpg">House Scene 6</option>
            <option value="scene_house5" src="assets/preview/scene_house5.jpg">House Scene 5</option>
            <option value="scene_house2" src="assets/preview/scene_house2.jpg">House Scene 2</option>
            <option value="scene_park4" src="assets/preview/scene_park4.jpg">Park Scene 4</option>
          </optgroup>

        </a-entity>

      </a-entity>

      <!-- City -->
      <a-entity id="city" firebase-broadcast></a-entity>

      <!-- Table and Grid -->
      <a-entity id="tableGrid" position="0.25 0.5 0.25" gridhelper="divisions:20">
        <a-box id="tableTop" position="0.12 -0.01 -1.02" width="3" height="0.1" depth="2" color="#09620b" material="color:#09620b" geometry="primitive:box;width:3;height:0.1;depth:2" scale="0.9 0.19999999999999996 0.78"></a-box>
        <a-entity id="tableBase" scale="0.015 0.015 0.015" position="0.18 -0.02 -1" rotation="0 0 0" obj-model="obj:#table-obj;mtl:#table-mtl"></a-entity>
      </a-entity>

      <!-- Floor -->
      <a-entity id="floor" color="#603a2b" material="color:#603a2b" geometry="primitive: circle; radius: 2.5" position="0 0 0" rotation="-90 0 0" ></a-entity>

      <a-entity position="-3 1 -6" rotation="5 0 0">

        <!-- City Builder Geometric Text Title adapted from Ada Rose's https://aframe.io/examples/showcase/hello-metaverse/ -->
        <!-- <a-entity position="-0.5 0.5 -0.5" scale="0.6 1.2 1" text="text:CITY BUILDER;font:#exoBlackRegular;bevelEnabled:true;bevelSize:0.1;bevelThickness:0.1;curveSegments:1;size:1.5;height:0.5" material="color:white;metalness:0.9;roughness:0.05;sphericalEnvMap:#chrome"></a-entity>
        <a-entity position="-1 2.15 0.3" text="text:A-Frame; font:#exoBoldItalic;style:italic;size:0.8;weight:bold;height:0;" material="shader:flat;color:white;" rotation="0 0 0" scale="1 1 1" visible="true"></a-entity>
        <a-entity position="-1 2.15 0.3" text="text:A-Frame;font:#exoBoldItalic;style:italic;size:0.8;weight:bold;height:0;bevelEnabled:true;bevelSize:0.04;bevelThickness:0.04;curveSegments:1" material="shader:flat;color:white;transparent:true;opacity:0.4"></a-entity> -->

        <!-- temporary replacement for geometric text when it broke upon aframe 0.4.0 release -->
        <a-plane position="3.5 1 -0.5" scale="5 1 0" src="assets/images/aframecity.png" material="opacity:0.6"></a-plane>

      </a-entity>

      <!-- Environment -->
      <a-entity id="sky"
                geometry="primitive: sphere; radius: 65;"
                material="shader: skyGradient; colorTop: #353449; colorBottom: #BC483E; side: back"></a-entity>
      <a-entity ground></a-entity>
      <a-entity light="color: white; intensity: 0.5" position="-5 5 15"></a-entity>
      <a-entity light="color: white;  intensity: 0.5; type: ambient;"></a-entity>
    </a-scene>

    <!-- dialog box overlay for desktop users -->
    <div id="dialog" class="img-rounded intro-overlay">
              <!-- <p><a onclick="hide()" class="btn btn-danger pull-right">x</a></p> -->
              <h4><strong>A-Frame City Builder</strong></h4>
              <p>This app lets you create a virtual city in 8-bit "pixel" style using the HTC Vive or Oculus Rift VR headset and tracked hand controllers. You will also need a <a href="https://webvr.info/">WebVR compatible browser</a>.</p>
              <p><a href="https://github.com/mikelovesrobots/mmmm">"Mini Mike's Metro Mini"</a> objects are CC License, <a href="https://github.com/kfarr/aframe-city-builder">codebase is MIT</a>.</p>
              <h5>CONTROLS - Supports both Oculus Touch and Vive Controls</h5>
              <p>Place objects with <code>trigger</code> and undo the last placement by squeezing a <code>grip</code> button. Switch objects by pressing <code>right</code> or <code>left</code> on touchpad or thumbstick. Press <code>up</code> or <code>down</code> to switch object groups.
              <h5>LOAD and SAVE:</h5>
              <p><div class="input-group">
                <input id="fileInput" type="text" class="form-control" onfocus="this.select();" placeholder="Enter JSON URL" value="example-aframe-city.json">
                <span class="input-group-btn">
                  <button onclick="loadFileButton()" class="btn btn-info" type="button">Load JSON URL</button>
                </span>
              </div></p>
              <p><div class="input-group">
                <input id="jsonInput" type="text" class="form-control" placeholder="Paste JSON String Here">
                <span class="input-group-btn">
                  <button onclick="loadButton()" class="btn btn-info" type="button">Load JSON String</button>
                </span>
              </div></p>
              <p><a onclick="saveButton()" class="btn btn-info">Download City Layout as JSON â–¼</a></p>
              <p><a onclick="hide()" class="btn btn-success pull-right">Close</a></p>
    </div>
    <a onclick="show()"><div class="menu-overlay btn btn-outline-secondary"></div></a>

    <script type="text/javascript">
      var enteredVR = false;

      document.querySelector('a-scene').addEventListener('enter-vr', function () {
         console.log("ENTERED VR");
         console.log(enteredVR);
         if (!enteredVR) {
           document.getElementById('cameraWrapper').setAttribute("position", "0 0 0");
           document.getElementById('cameraWrapper').setAttribute("rotation", "0 0 0");
           enteredVR = true;
         };
      }); // works the first time, but then makes things wonky the 2nd time

      document.querySelector('a-scene').addEventListener('exit-vr', function () {
         console.log("EXIT VR");
        //  document.getElementById('cameraWrapper').setAttribute("position", "-1.06 1.31 1.82"); // position="-1.06 1.31 1.82"
        //  document.getElementById('cameraWrapper').setAttribute("rotation", "-12.834254610930437 -16.844959176846217 0");
      }); // works the first time
    </script>

    <!-- <script type="text/javascript">
    AFRAME.registerComponent('ply-transform', {
      init: function () {
        this.el.addEventListener('model-loaded', function (e) {
          var model = e.detail.model;
          model.rotation.x = Math.PI / 2;
        });
      }
    });
    </script> -->

    <script type="text/javascript">
          function hide() {
              $("#dialog").removeClass('intro-overlay');
          }

          function loadTest() {
            // test a user going through the menu options a bunch
            for (g = 0; g < 5; g++) {
              for (i = 0; i < 20; i++) {
                setTimeout(function(){document.getElementById("menu").emit("onOptionNext")}, 500);
              }
              setTimeout(function(){document.getElementById("menu").emit("onOptgroupNext")}, 500);
            }

          }

          function saveButton() {
            var cityNode = $("#city")[0];
            var cityJSON = [];

            // fetch each city object and add into json
            $('#city').children().each(function () {
              var thisWorldRotationX = this.object3D.rotation.x / (Math.PI / 180);
        			var thisWorldRotationY = this.object3D.rotation.y / (Math.PI / 180);
        			var thisWorldRotationZ = this.object3D.rotation.z / (Math.PI / 180);
        			var thisEulerRotationString = thisWorldRotationX + ' ' + thisWorldRotationY + ' ' + thisWorldRotationZ;

              var childJSON = {
                  id: this.id,
                  file: this.getAttribute('file'),
                  position: this.object3D.position.x + ' ' + this.object3D.position.y + ' ' + this.object3D.position.z,
                  rotation: thisEulerRotationString,
                  scale: this.object3D.scale.x + ' ' + this.object3D.scale.y + ' ' + this.object3D.scale.z
              };

              cityJSON.push(childJSON);
            });

            var jsonData = JSON.stringify(cityJSON);

            function download(text, name, type) {
                var a = document.createElement("a");
                var file = new Blob([text], {type: type});
                a.href = URL.createObjectURL(file);
                a.download = name;
                a.click();
            }
            download(jsonData, 'my-aframe-city.json', 'text/plain');
          }

          function appendObject(id, file, scale, position, rotation, scale) {
            console.log(position);
            $('<a-entity />', {
              id: id,
              class: 'city object children',
              position: position,  // doesn't seem to do anything
              scale: scale,
              rotation: rotation,
              file: file,
              "obj-model": "obj: url(assets/obj/" + file + ".obj); mtl: url(assets/obj/" + file + ".mtl)",
              // src: '#' + file + '-obj',
              // mtl: '#' + file + '-mtl',
              appendTo : $('#city')
            });
           document.getElementById(id).setAttribute("position", position); // workaround - this does set position
           document.getElementById(id).setAttribute("firebase-broadcast", "components: position, scale, rotation, file, obj-model, class");

          }

          function toDOM(jsonInput) {
            for(var i = 0; i < jsonInput.length; i++) {
                var obj = jsonInput[i];
                console.log("Adding entity #" + obj.id);
                appendObject(obj.id, obj.file, obj.scale, obj.position, obj.rotation, obj.scale)
            }
          }

          function loadFileButton() {
            $.getJSON($("#fileInput")[0].value, function(json) {
                toDOM(json);
            });
          }

          function loadButton() {
            console.log("load button clicked");

            function IsJsonString(str) {
                try {
                    JSON.parse(str);
                } catch (e) {
                    return false;
                }
                return true;
            }

            jsonInput = $("#jsonInput")[0].value;
            console.log(jsonInput);

            if (IsJsonString(jsonInput)) {
              toDOM(JSON.parse(jsonInput));
            } else {
              console.log("oops not valid json");
            }

          }
          function show() {
             $("#dialog").toggleClass('intro-overlay');
          }

          if (screen.width <= 699) {
            $("#dialog").removeClass('intro-overlay');
          }
    </script>

    <!--githubcorner-->
    <a href="https://github.com/kfarr/aframe-city-builder" class="github-corner">
      <svg width="80" height="80" viewBox="0 0 250 250" style="fill: #111; color: #EFEFEF; position: fixed; bottom: 0; border: 0; left: 0; transform: rotate(180deg); opacity: 0.8">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
      </svg>
    </a>
    <style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}
    </style>

  </body>
</html>
